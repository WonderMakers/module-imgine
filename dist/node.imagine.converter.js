!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var o in r)("object"==typeof exports?exports:e)[o]=r[o]}}(global,(()=>(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);const t=require("node-fetch"),r=require("./../../utils/math"),o=require("./_options.js"),s=require("../../utils/cache");return module.exports=class{constructor(e,t){this.options=Object.assign({},{fetchCacheLimit:100},t),this.sharp=e,this.cache={upload:new s(t.fetchCacheLimit),sharping:new s(t.fetchCacheLimit)}}async fetchResource(e){const r={url:e},o=this.cache.upload.get(r);if(o)return Promise.resolve(o);try{console.log("fetchResource",e);const o=await t.default(e),s={buffer:await o.buffer(),url:e};return console.log("fetchResource success",e),this.cache.upload.add(r,s),Promise.resolve(s)}catch(e){return this.cache.upload.remove(r),Promise.resolve(null)}}async sharping(e,t){const r=this.makeConvertingOptions(t),o={url:e.url,...r},s=this.cache.sharping.get(o);if(s)return s;try{const t=this.sharp(e.buffer);r.r&&t.rotate(r.r),r.b&&t.blur(r.b),t.resize({width:r.w,height:r.h}),t.toFormat(r.f,{quality:r.q});const s=await t.toBuffer(),i=`image/${r.f}`,c=r.f;return this.cache.sharping.add(o,{buffer:s,contentType:i,format:c})}catch(e){return console.log("Sharping error:",e),null}}async convert(e,t={}){const r=await this.fetchResource(e);return r?this.sharping(r,t):Promise.resolve(null)}makeConvertingOptions(e){return Object.keys(o).reduce(((t,s)=>{const i=o[s].validator,c=o[s].type,n=o[s].default,a=e[s];return c===Number?(t[s]=+r.clamp(0,6e3,a)||n,t):c===String?i?(t[s]=i(a)?a:n,t):(t[s]=a,t):t}),{})}},e})()));